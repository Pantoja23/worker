<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pantoja Tile | Staff Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #6366f1; 
            --bg: #030712; 
            --card: rgba(31, 41, 55, 0.6); 
            --text: #f9fafb; 
            --accent: #10b981; 
            --red: #ef4444; 
            --blue: #3b82f6;
            --border: rgba(255, 255, 255, 0.1);
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background: var(--bg); 
            color: var(--text); 
            margin: 0; 
            padding: 15px; 
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* LOGO DE FONDO DINÁMICO */
        .bg-logo { 
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            width: 90%; opacity: 0.04; filter: blur(10px); z-index: -1; pointer-events: none; 
        }

        .container { max-width: 480px; margin: auto; }

        /* ESTILO GLASSMORPHISM */
        .glass-card { 
            background: var(--card); 
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-radius: 24px; 
            border: 1px solid var(--border); 
            padding: 24px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.4);
            margin-bottom: 20px;
        }

        /* INPUTS MODERNOS */
        .input-group { margin-bottom: 15px; text-align: left; }
        .input-group label { display: block; font-size: 11px; font-weight: 800; color: var(--primary); text-transform: uppercase; margin-bottom: 8px; letter-spacing: 1px; }
        input, textarea { 
            width: 100%; padding: 16px; border-radius: 16px; border: 1px solid var(--border); 
            background: rgba(0,0,0,0.2); color: white; box-sizing: border-box; font-size: 16px; transition: 0.3s;
        }
        input:focus { border-color: var(--primary); outline: none; background: rgba(0,0,0,0.4); }

        /* BOTONES DE ACCIÓN (ICONOS) */
        .action-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin: 20px 0; }
        .btn-circle { 
            height: 60px; border-radius: 18px; border: none; color: white; font-size: 22px; 
            display: flex; align-items: center; justify-content: center; text-decoration: none; transition: 0.3s;
        }
        .bg-ws { background: linear-gradient(135deg, #25d366, #128c7e); }
        .bg-tel { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .bg-map { background: linear-gradient(135deg, #ef4444, #b91c1c); }
        .btn-circle:active { transform: scale(0.92); }

        /* TARJETAS DE TRABAJO */
        .job-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 20px; border-radius: 20px; background: rgba(255,255,255,0.03);
            border: 1px solid var(--border); margin-bottom: 12px; transition: 0.3s;
        }
        .job-item:active { background: rgba(99, 102, 241, 0.1); border-color: var(--primary); }
        .job-id-tag { background: var(--primary); font-size: 10px; font-weight: 900; padding: 4px 10px; border-radius: 8px; }

        /* TIMER & PUNCH */
        .timer-display { font-size: 3.5rem; font-weight: 800; text-align: center; margin: 15px 0; font-variant-numeric: tabular-nums; letter-spacing: -2px; color: white; }
        
        .btn-punch { 
            width: 100%; padding: 20px; border-radius: 20px; border: none; font-weight: 800; font-size: 16px; 
            display: flex; align-items: center; justify-content: center; gap: 12px; text-transform: uppercase; letter-spacing: 1px;
        }
        .in { background: var(--accent); color: #064e3b; box-shadow: 0 10px 20px rgba(16, 185, 129, 0.2); }
        .out { background: var(--red); color: white; box-shadow: 0 10px 20px rgba(239, 68, 68, 0.2); }

        .desc-text { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 16px; font-size: 14px; line-height: 1.6; color: #d1d5db; margin: 15px 0; }
    </style>
</head>
<body>
    <img src="img/logo.png" class="bg-logo">
    <div class="container">

        <div id="login_section" style="padding-top: 80px; text-align: center;">
            <img src="img/logo.png" style="width: 110px; margin-bottom: 30px; filter: drop-shadow(0 0 20px var(--primary));">
            <div class="glass-card">
                <h2 style="margin-bottom: 30px; letter-spacing: 2px;">STAFF <span style="color:var(--primary)">PRO</span></h2>
                <div class="input-group">
                    <label>Email Corporativo</label>
                    <input type="email" id="email" placeholder="usuario@pantojatile.com">
                </div>
                <div class="input-group">
                    <label>Contraseña</label>
                    <input type="password" id="pass" placeholder="••••••••">
                </div>
                <button class="btn-punch in" onclick="login()" style="background:var(--primary); color:white; margin-top:10px;">Acceder al Sistema</button>
            </div>
        </div>

        <div id="list_section" style="display:none;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px; padding:0 10px;">
                <h2 id="welcome_text" style="margin:0; font-size: 20px;"></h2>
                <div onclick="location.reload()" style="background:rgba(239, 68, 68, 0.1); color:var(--red); padding:10px; border-radius:12px;"><i class="fas fa-power-off"></i></div>
            </div>
            <p style="font-size: 12px; color: var(--primary); font-weight: 800; text-transform: uppercase; margin-left: 10px; letter-spacing: 1px;">Trabajos Asignados</p>
            <div id="jobs_container"></div>
        </div>

        <div id="work_panel" style="display:none;">
            <div class="glass-card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <span class="job-id-tag" id="active_job_id"></span>
                    <i class="fas fa-arrow-left" onclick="cancelSelection()" style="color:#6b7280; font-size: 20px;"></i>
                </div>
                
                <h2 id="active_job_client" style="margin:0; font-size: 28px;"></h2>
                <p id="active_job_service" style="color:var(--primary); font-weight: 600; margin: 5px 0 20px 0; font-size: 14px;"></p>

                <div class="action-grid">
                    <a id="link_phone" class="btn-circle bg-tel"><i class="fas fa-phone-alt"></i></a>
                    <a id="link_ws" class="btn-circle bg-ws" target="_blank"><i class="fab fa-whatsapp"></i></a>
                    <a id="link_maps" class="btn-circle bg-map" target="_blank"><i class="fas fa-directions"></i></a>
                </div>

                <div class="input-group">
                    <label>Instrucciones del Proyecto</label>
                    <div class="desc-text" id="active_job_desc"></div>
                </div>

                <div class="timer-display" id="timer">00:00:00</div>
                
                <div class="input-group">
                    <label>Reporte de Actividad</label>
                    <textarea id="staff_notes" rows="3" placeholder="Describe brevemente el avance de hoy..."></textarea>
                </div>
                
                <button id="btn_punch" class="btn-punch in" onclick="handlePunch()">
                    <i class="fas fa-play"></i> Punch In
                </button>
            </div>
        </div>
    </div>

<script>
    const URL_SCRIPT = "https://script.google.com/macros/s/AKfycbxbrwVzws8GlD8tdq7eS7eWO6K_XqHNNfR7atniDElsD-9XZ5jcStyWTfksGcgj_WiV/exec"; 
    let currentUser = "";
    let selectedJob = null;
    let isWorking = false;
    let startTime;
    let timerInterval;

    async function login() {
        const email = document.getElementById('email').value;
        const pass = document.getElementById('pass').value;
        const res = await fetch(`${URL_SCRIPT}?action=login_staff&email=${email}&pass=${pass}`);
        const data = await res.json();
        if(data.success) {
            currentUser = data.name;
            document.getElementById('welcome_text').innerText = "Hola, " + currentUser.split(' ')[0];
            document.getElementById('login_section').style.display = 'none';
            document.getElementById('list_section').style.display = 'block';
            loadJobs();
        } else { alert("Credenciales incorrectas."); }
    }

    async function loadJobs() {
        const res = await fetch(`${URL_SCRIPT}?action=get_worker_orders&workerName=${currentUser}`);
        const jobs = await res.json();
        document.getElementById('jobs_container').innerHTML = jobs.map(t => `
            <div class="job-item" onclick='viewJob(${JSON.stringify(t)})'>
                <div>
                    <span class="job-id-tag">${t.id}</span>
                    <div style="margin-top:10px; font-weight:800; font-size:18px;">${t.nombre_cliente}</div>
                    <div style="color:var(--primary); font-size:12px; font-weight:600;">${t.servicio}</div>
                </div>
                <i class="fas fa-chevron-right" style="color:var(--border);"></i>
            </div>
        `).join('');
    }

    function viewJob(job) {
        selectedJob = job;
        document.getElementById('list_section').style.display = 'none';
        document.getElementById('work_panel').style.display = 'block';
        document.getElementById('active_job_id').innerText = job.id;
        document.getElementById('active_job_client').innerText = job.nombre_cliente;
        document.getElementById('active_job_service').innerText = job.servicio;
        document.getElementById('active_job_desc').innerText = job.instrucciones || "Favor de contactar al admin para instrucciones.";
        
        document.getElementById('link_phone').href = `tel:${job.telefono}`;
        const msg = encodeURIComponent(`Hola ${job.nombre_cliente}, le saluda ${currentUser} de Pantoja Tile. Ya estoy en camino a su domicilio para el proyecto de ${job.servicio}. ¡Nos vemos pronto!`);
        document.getElementById('link_ws').href = `https://wa.me/1${String(job.telefono).replace(/\D/g,'')}?text=${msg}`;
        document.getElementById('link_maps').href = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(job.direccion)}`;
    }

    function cancelSelection() {
        if(isWorking) return;
        document.getElementById('work_panel').style.display = 'none';
        document.getElementById('list_section').style.display = 'block';
    }

    async function handlePunch() {
        const btn = document.getElementById('btn_punch');
        const notes = document.getElementById('staff_notes').value;
        if(!isWorking) {
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Registrando...';
            await fetch(URL_SCRIPT, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'PUNCH_IN', id: selectedJob.id, worker: currentUser, cliente: selectedJob.nombre_cliente, direccion: selectedJob.direccion, servicio: selectedJob.servicio })});
            isWorking = true;
            startTime = new Date();
            btn.className = "btn-punch out";
            btn.innerHTML = '<i class="fas fa-stop"></i> Terminar Turno';
            timerInterval = setInterval(() => {
                let diff = Math.floor((new Date() - startTime) / 1000);
                let h = Math.floor(diff / 3600), m = Math.floor((diff % 3600) / 60), s = diff % 60;
                document.getElementById('timer').innerText = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
            }, 1000);
        } else {
            if(!notes) return alert("Escribe el reporte de actividad antes de salir.");
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
            await fetch(URL_SCRIPT, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'PUNCH_OUT', id: selectedJob.id, worker: currentUser, notas: notes })});
            location.reload();
        }
    }
</script>
</body>
</html>
